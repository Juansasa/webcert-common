angular.module("common",["ui.bootstrap","ngCookies","ngRoute","ngSanitize"]),angular.module("common").run(["common.messageService",function(messageService){"use strict";messageService.addResources(commonMessages)}]);var commonMessages={sv:{"common.continue":"Fortsätt","common.yes":"Ja","common.no":"Nej","common.yes.caps":"JA","common.no.caps":"NEJ","common.nodontask":"Nej, fråga inte igen","common.ok":"OK","common.cancel":"Avbryt","common.goback":"Tillbaka","common.revoke":"Intyget ska återtas","common.sign":"Signera","common.send":"Skicka","common.copy":"Kopiera","common.delete":"Radera","common.date":"Datum","common.when":"När?","common.modal.label.discard_draft":"Ta bort utkast","common.modal.label.confirm_sign":"Signera intyget","cert.status.draft_incomplete":"Utkast, uppgifter saknas","cert.status.draft_complete":"Utkast, kan signeras","cert.status.signed":"Signerat","cert.status.cancelled":"Makulerat","cert.status.unknown":"Okänd","cert.status.sent":"Mottaget","cert.status.received":"Signerat","common.label.ovanstaende-har-bekraftats":"Ovanstående uppgifter och bedömningar bekräftas","draft.status.draft_incomplete":"<strong>Status:</strong> Utkastet är sparat, men obligatoriska uppgifter saknas.","draft.status.draft_complete":"<strong>Status:</strong> Utkastet är sparat och kan signeras.","draft.status.signed":"<strong>Status:</strong> Intyget är signerat.","draft.status.changed":"<strong>Status:</strong> Utkastet är ändrat sedan det senast sparades","draft.saknar-uppgifter":"Utkastet saknar uppgifter","draft.onlydoctorscansign":"Endast läkare får signera intyget. Skicka ett mejl med en länk till utkastet till den läkare som ska signera.","nav.label.loggedinas":"Inloggad som:","modal.title.markforward":"Markera som vidarebefordrad?","qa.status.pending_internal_action":"Kräver svar","qa.status.pending_external_action":"Inväntar svar","qa.status.answered":"Besvarat","qa.status.closed":"Hanterat","qa.fragestallare.fk":"Försäkringskassan","qa.fragestallare.wc":"Vårdenheten","qa.amne.paminnelse":"Påminnelse","qa.amne.arbetstidsforlaggning":"Arbetstidsförläggning","qa.amne.kontakt":"Kontakt","qa.amne.avstamningsmote":"Avstämningsmöte","qa.amne.komplettering_av_lakarintyg":"Komplettering av läkarintyg","qa.amne.makulering_av_lakarintyg":"Makulering av läkarintyg","qa.amne.ovrigt":"Övrigt","qa.measure.svarfranvarden":"Svara","qa.measure.svarfranfk":"Invänta svar från Försäkringskassan","qa.measure.komplettering":"Komplettera","qa.measure.markhandled":"Markera som hanterad","qa.measure.handled":"Ingen","modules.label.field":"Fält","modules.label.blank":"- ej ifyllt","modules.button.alt.archive":"Arkivera intyget. Flyttar intyget till Arkiverade intyg","info.loadingcertificate":"Hämtar intyget...","common.error.unknown":"<strong>Tekniskt fel</strong>","common.error.cantconnect":"<strong>Kunde inte kontakta servern</strong>","common.error.certificatenotfound":"<strong>Intyget finns inte</strong>","common.error.certificateinvalid":"<strong>Intyget är inte korrekt ifyllt</strong>","common.error.signerror":"<strong>Intyget kunde inte signeras.</strong><br>Försök igen senare.","common.error.unknown_internal_problem":"<strong>Tekniskt fel i Webcert.</strong><br>Försök igen senare.","common.error.data_not_found":"<strong>Intyget kunde inte hittas.</strong><br>Intyget är borttaget eller så saknas behörighet."},en:{"common.ok":"OK","common.cancel":"Cancel"}};angular.module("common").directive("message",["$log","$rootScope","common.messageService",function($log,$rootScope,messageService){"use strict";return{restrict:"EA",scope:{key:"@",param:"=",params:"="},replace:!0,template:'<span ng-bind-html="resultValue"></span>',link:function(scope,element,attr){var result;attr.$observe("key",function(interpolatedKey){var useLanguage,normalizedKey=angular.lowercase(interpolatedKey);if(useLanguage="undefined"!=typeof attr.lang?attr.lang:$rootScope.lang,result=messageService.getProperty(normalizedKey,null,attr.fallback,useLanguage,"undefined"!=typeof attr.fallbackDefaultLang),"undefined"!=typeof scope.param)$log.debug(scope.param),result=result.replace("%0",scope.param);else if("undefined"!=typeof scope.params)for(var myparams=scope.params,i=0;i<myparams.length;i++)result=result.replace("%"+i,myparams[i]);scope.resultValue=result})}}}]),angular.module("common").directive("wcEnableTooltip",["common.messageService",function(messageService){"use strict";return{restrict:"A",transclude:!0,scope:{fieldHelpText:"@"},controller:["$scope",function($scope){$scope.getMessage=function(key){return messageService.getProperty(key)}}],templateUrl:"/web/webjars/common/webcert/js/directives/wcEnableTooltip.html"}}]),angular.module("common").directive("wcEyeDecimal",function(){"use strict";return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ngModelCtrl){function filter(s){var filtered="",dec=!1;angular.forEach(s,function(c){number.test(c)&&(filtered+=c),!dec&&decimalPoint.test(c)&&(dec=!0,filtered+=",")});var maxLength=dec?3:2;return filtered.length<=maxLength?filtered:filtered.substring(0,maxLength)}function format(value){var valForModel,l=value.length,valForView="";return 0===l?valForModel=null:(1===l?valForView=","===value[0]?"0,0":value[0]+",0":2===l?valForView=","===value[0]?"0,"+value[1]:","===value[1]?value[0]+",0":value[0]+","+value[1]:3===l&&(valForView=","===value[0]?"0,"+value[1]:","===value[1]?value:value[0]+","+value[1]),valForModel=Number(valForView[0]+"."+valForView[2])),{valForView:valForView,valForModel:valForModel}}function blurFormat(){var filtered=filter(this.value),val=format(filtered);this.value!==val.valForView&&(this.value=val.valForView)}function eyeDecimal(valFromView){var filtered=filter(valFromView),val=format(filtered);return filtered!==valFromView&&(ngModelCtrl.$setViewValue(filtered),ngModelCtrl.$render()),val.valForModel}var decimalPoint=/[\,,\.]/,number=/[0-9]/;elem.bind("blur",blurFormat),ngModelCtrl.$parsers.push(eyeDecimal)}}}),angular.module("common").directive("wcField",["common.messageService",function(messageService){"use strict";return{restrict:"A",transclude:!0,replace:!0,templateUrl:"/web/webjars/common/webcert/js/directives/wcField.html",scope:{fieldLabel:"@",fieldNumber:"@?",fieldHelpText:"@",fieldHasErrors:"=",fieldTooltipPlacement:"@",filled:"@?"},compile:function(element,attrs){attrs.filled||(attrs.filled=!0)},controller:["$scope",function($scope){null===$scope.fieldNumber&&($scope.fieldNumber=void 0),$scope.placement=void 0===$scope.fieldTooltipPlacement?"right":$scope.fieldTooltipPlacement,$scope.getMessage=function(key){return messageService.getProperty(key)}}]}}]),angular.module("common").directive("wcFieldSingle",function(){"use strict";return{restrict:"A",transclude:!0,replace:!0,scope:{fieldNumber:"@"},template:'<div class="body-row body-row-single clearfix"><h4 class="cert-field-number" ng-if="fieldNumber != undefined"><span message key="modules.label.field"></span> {{fieldNumber}}</h4><span ng-transclude></span></div>'}}),angular.module("common").directive("wcFocusMe",function(){"use strict";return{scope:{trigger:"=wcFocusMe"},link:function(scope,element){scope.$watch("trigger",function(value){value===!0&&(element[0].focus(),scope.trigger=!1)})}}}),angular.module("common").directive("wcHeader",["$cookieStore","$location","$modal","$window","common.messageService","common.statService","common.User",function($cookieStore,$location,$modal,$window,messageService,statService,User){"use strict";return{restrict:"A",replace:!0,scope:{defaultActive:"@"},controller:["$scope",function($scope){$scope.today=new Date,$scope.user=User,$scope.statService=statService,$scope.statService.startPolling(),$scope.stat={fragaSvarValdEnhet:0,fragaSvarAndraEnheter:0,intygValdEnhet:0,intygAndraEnheter:0,vardgivare:[]},$scope.$on("wc-stat-update",function(event,message){$scope.stat=message}),$scope.menuDefs=[{link:"/web/dashboard#/unhandled-qa",label:"Frågor och svar",requiresDoctor:!1,statNumberId:"stat-unitstat-unhandled-question-count",statTooltip:"not set",getStat:function(){return this.statTooltip="Vårdenheten har "+$scope.stat.fragaSvarValdEnhet+" ej hanterade frågor och svar.",$scope.stat.fragaSvarValdEnhet||""}},{link:"/web/dashboard#/unsigned",label:messageService.getProperty("dashboard.unsigned.title"),requiresDoctor:!1,statNumberId:"stat-unitstat-unsigned-certs-count",statTooltip:"not set",getStat:function(){return this.statTooltip="Vårdenheten har "+$scope.stat.intygValdEnhet+" ej signerade utkast.",$scope.stat.intygValdEnhet||""}},{link:"/web/dashboard#/webcert/about",label:"Om Webcert",requiresDoctor:!1,getStat:function(){return""}}];var writeCertMenuDef={link:"/web/dashboard#/create/index",label:"Sök/skriv intyg",requiresDoctor:!1,getStat:function(){return""}};User.userContext.lakare?$scope.menuDefs.splice(0,0,writeCertMenuDef):$scope.menuDefs.splice(2,0,writeCertMenuDef),$scope.isActive=function(page){if(!page)return!1;if(page=page.substr(page.lastIndexOf("/")+1),angular.isString($scope.defaultActive)&&page===$scope.defaultActive)return!0;var currentRoute=$location.path().substr($location.path().lastIndexOf("/")+1);return page===currentRoute},$scope.logout=function(){"urn:inera:webcert:fake"===User.userContext.authenticationScheme?$window.location="/logout":(iid_Invoke("Logout"),$window.location="/saml/logout/")},$scope.openChangeCareUnitDialog=function(){$modal.open({templateUrl:"/web/webjars/common/webcert/js/directives/wcHeaderCareUnitDialog.html",controller:["$scope","$modalInstance","vardgivare",function($scope,$modalInstance,vardgivare){$scope.vardgivare=vardgivare,$scope.error=!1,$scope.close=function(){$modalInstance.close()},$scope.selectVardenhet=function(enhet){$scope.error=!1,User.setValdVardenhet(enhet,function(){$cookieStore.remove("enhetsId"),$location.path(User.userContext.lakare===!0?"/":"/unhandled-qa"),$modalInstance.close()},function(){$scope.error=!0})}}],resolve:{vardgivare:function(){return angular.copy($scope.stat.vardgivare)}}})}}],templateUrl:"/web/webjars/common/webcert/js/directives/wcHeader.html"}}]),angular.module("common").directive("wcMaxlength",["$compile",function($compile){"use strict";return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,controller){function limitLength(text){if(void 0!==text){if(text.length>attrs.maxlength){var transformedInput=text.substring(0,attrs.maxlength);return controller.$setViewValue(transformedInput),controller.$render(),transformedInput}return scope[counterName]=attrs.maxlength-text.length,text}}var counterName="charsRemaining"+element[0].id;counterName=counterName.replace(".",""),scope[counterName]=attrs.maxlength;var counter=angular.element('<div class="counter">Tecken kvar: {{'+counterName+"}}</div>");$compile(counter)(scope),element.parent().append(counter),controller.$formatters.unshift(limitLength),controller.$parsers.unshift(limitLength)}}}]),angular.module("common").directive("wcPrintHeader",["common.User",function(User){"use strict";return{restrict:"A",replace:!0,scope:{titleId:"@",printMessageId:"@",intygsId:"="},controller:["$scope",function($scope){$scope.today=new Date,$scope.user=User}],templateUrl:"/web/webjars/common/webcert/js/directives/wcPrintHeader.html"}}]),angular.module("common").directive("wcSpinner",function(){"use strict";return{restrict:"A",transclude:!0,replace:!0,scope:{label:"@",showSpinner:"=",showContent:"="},templateUrl:"/web/webjars/common/webcert/js/directives/wcSpinner.html"}}),angular.module("common").directive("wcDatePickerField",["$rootScope","$timeout",function($rootScope,$timeout){"use strict";return{restrict:"A",replace:!0,scope:{targetModel:"=",domId:"@",invalid:"=",onChange:"&"},templateUrl:"/web/webjars/common/webcert/js/directives/wcDatePickerField.html",controller:["$scope",function($scope){$scope.$watch("targetModel",function(){$scope.onChange&&$scope.onChange()},!1),$scope.isOpen=!1,$scope.toggleOpen=function(){$timeout(function(){$scope.isOpen=!$scope.isOpen})}}]}}]),angular.module("common").directive("wcPersonNumber",function(){"use strict";function pad(number){return 10>number?"0"+number:number}function isDateValid(dateStr){return moment(dateStr,"YYYY/MM/DD").isValid()}function isDateInValidRange(dateStr){var yearsDiff=moment().diff(moment(dateStr,"YYYY/MM/DD"),"years");return MAXIMUM_AGE+1>yearsDiff}var PERSONNUMMER_REGEXP=/^(\d{2})?(\d{2})(\d{2})([0-3]\d)([-+]?)(\d{4})$/,SAMORDNINGSNUMMER_REGEXP=/^(\d{2})?(\d{2})(\d{2})([6-9]\d)-?(\d{4})$/,MAXIMUM_AGE=125,isCheckDigitValid=function(value){for(var cleanValue=value.replace(/[-+]/,""),digits=cleanValue.substring(0,cleanValue.length-1).split(""),multipliers=[2,1,2,1,2,1,2,1,2],digitsMultiplied="",i=0;i<digits.length;i++)digitsMultiplied+=parseInt(digits[i],10)*multipliers[i];digits=digitsMultiplied.split("");var sum=0;for(i=0;i<digits.length;i++)sum+=parseInt(digits[i],10);sum%=10;var checkDigit=cleanValue.substring(cleanValue.length-1);return 0===sum&&"0"===checkDigit?!0:10-sum===parseInt(checkDigit,10)},formatPersonnummer=function(date,number){return""+date.getFullYear()+pad(date.getMonth()+1)+pad(date.getDate())+"-"+number},formatSamordningsnummer=function(date,number){return""+date.getFullYear()+pad(date.getMonth()+1)+pad(date.getDate()+60)+"-"+number};return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){ctrl.$parsers.unshift(function(viewValue){var date,dateStr,parts=PERSONNUMMER_REGEXP.exec(viewValue);if(PERSONNUMMER_REGEXP.lastIndex=0,parts){if(parts[1]){if(dateStr=parts[1]+parts[2]+"/"+parts[3]+"/"+parts[4],!isDateValid(dateStr)||!isDateInValidRange(dateStr))return void ctrl.$setValidity("personNumberValidate",!1);date=new Date(dateStr)}else{if(dateStr=parseInt(parts[2],10)+2e3+"/"+parts[3]+"/"+parts[4],!isDateValid(dateStr))return void ctrl.$setValidity("personNumberValidate",!1);date=new Date(dateStr),date>new Date&&date.setFullYear(date.getFullYear()-100),"+"===parts[5]&&date.setFullYear(date.getFullYear()-100)}return isCheckDigitValid(parts[2]+parts[3]+parts[4]+parts[6])?(ctrl.$setValidity("personNumberValidate",!0),formatPersonnummer(date,parts[6])):void ctrl.$setValidity("personNumberValidate",!1)}if(parts=SAMORDNINGSNUMMER_REGEXP.exec(viewValue),SAMORDNINGSNUMMER_REGEXP.lastIndex=0,parts){var day=parseInt(parts[4],10)-60;if(parts[1]){if(dateStr=parts[1]+parts[2]+"/"+parts[3]+"/"+pad(day),!isDateValid(dateStr)||!isDateInValidRange(dateStr))return void ctrl.$setValidity("personNumberValidate",!1);date=new Date(dateStr)}else{if(dateStr=parseInt(parts[2],10)+2e3+"/"+parts[3]+"/"+pad(day),!isDateValid(dateStr)||!isDateInValidRange(dateStr))return void ctrl.$setValidity("personNumberValidate",!1);date=new Date(dateStr),date>new Date&&date.setFullYear(date.getFullYear()-100)}return isCheckDigitValid(parts[2]+parts[3]+parts[4]+parts[5])?(ctrl.$setValidity("personNumberValidate",!0),formatSamordningsnummer(date,parts[5])):void ctrl.$setValidity("personNumberValidate",!1)}return void ctrl.$setValidity("personNumberValidate",!1)})}}}),angular.module("common").filter("BoolToTextFilter",function(){"use strict";return function(input){return input===!0?"common.yes":"common.no"}}),angular.module("common").factory("common.CertificateService",["$http","$log",function($http,$log){"use strict";function _handleError(callback,error){callback?callback(error):$log.error(error)}function _getCertificate(id,onSuccess,onError){$log.debug("_getCertificate id:"+id);var restPath="/moduleapi/intyg/signed/"+id;$http.get(restPath).success(function(data){$log.debug("_getCertificate data:"+data),onSuccess(data)}).error(function(data,status){$log.error("error "+status),onError(data)})}function _getDraft(id,onSuccess,onError){$log.debug("_getDraft id: "+id);var restPath="/moduleapi/intyg/draft/"+id;$http.get(restPath).success(function(data){$log.debug("_getDraft data: "+data),onSuccess(data)}).error(function(data,status){$log.error("error "+status),onError(data)})}function _saveDraft(id,cert,onSuccess,onError){$log.debug("_saveDraft id: "+id);var restPath="/moduleapi/intyg/draft/"+id;$http.put(restPath,cert).success(function(data){$log.debug("_saveDraft data: "+data),onSuccess(data)}).error(function(data,status){$log.error("error "+status),onError(data)})}function _discardDraft(id,onSuccess,onError){$log.debug("_discardDraft id: "+id);var restPath="/moduleapi/intyg/draft/"+id;$http["delete"](restPath).success(function(data){$log.debug("_discardDraft data: "+data),onSuccess(data)}).error(function(data,status){$log.error("error "+status),onError(data)})}function _getSigneringshash(intygId,onSuccess,onError){$log.debug("_getSigneringshash, intygId: "+intygId);var restPath="/moduleapi/intyg/signeringshash/"+intygId;$http.post(restPath).success(function(data){onSuccess(data)}).error(function(error){_handleError(onError,error)})}function _getSigneringsstatus(ticketId,onSuccess,onError){$log.debug("_getSigneringsstatus, ticketId: "+ticketId);var restPath="/moduleapi/intyg/signeringsstatus/"+ticketId;$http.get(restPath).success(function(data){onSuccess(data)}).error(function(error){_handleError(onError,error)})}function _signeraUtkast(intygId,onSuccess,onError){$log.debug("_signeraUtkast, intygId:"+intygId);var restPath="/moduleapi/intyg/signera/server/"+intygId;$http.post(restPath).success(function(data){onSuccess(data)}).error(function(error){_handleError(onError,error)})}function _signeraUtkastWithSignatur(ticketId,signatur,onSuccess,onError){$log.debug("_signeraUtkastWithSignatur, ticketId: "+ticketId);var restPath="/moduleapi/intyg/signera/klient/"+ticketId;$http.post(restPath).success(function(){onSuccess()}).error(function(error){_handleError(onError,error)})}function _sendSigneratIntyg(cert,recipientId,patientConsent,onSuccess,onError){$log.debug("_sendSigneratIntyg: "+cert.id);var restPath="/moduleapi/intyg/signed/"+cert.id+"/send";$http.post(restPath,{recipient:recipientId,patientConsent:patientConsent}).success(function(data){onSuccess(data)}).error(function(error){_handleError(onError,error)})}function _revokeSigneratIntyg(intygId,onSuccess,onError){$log.debug("_revokeSigneratIntyg: "+intygId);var restPath="/moduleapi/intyg/signed/"+intygId+"/revoke";$http.post(restPath,{}).success(function(data){'"OK"'===data?onSuccess():onError()}).error(function(error){_handleError(onError,error)})}function _logPrint(intygId,onSuccess,onError){$log.debug("_logPrint, intygId: "+intygId);var restPath="/moduleapi/intyg/draft/logprint";$http.post(restPath,intygId).success(function(data){onSuccess(data)}).error(function(error){_handleError(onError,error)})}return{getCertificate:_getCertificate,getDraft:_getDraft,saveDraft:_saveDraft,discardDraft:_discardDraft,getSigneringshash:_getSigneringshash,getSigneringsstatus:_getSigneringsstatus,revokeSigneratIntyg:_revokeSigneratIntyg,signeraUtkast:_signeraUtkast,signeraUtkastWithSignatur:_signeraUtkastWithSignatur,sendSigneratIntyg:_sendSigneratIntyg,logPrint:_logPrint}}]),angular.module("common").factory("common.dialogService",["$modal",function($modal){"use strict";function _showErrorMessageDialog(message,callback){var msgbox=$modal.open({templateUrl:"/web/webjars/common/webcert/js/services/dialogServiceErrorTemplate.html",controller:["$scope","$modalInstance","bodyText",function($scope,$modalInstance,bodyText){$scope.bodyText=bodyText}],resolve:{bodyText:function(){return angular.copy(message)}}});msgbox.result.then(function(result){callback&&callback(result)},function(){})}function _showMessageDialog(titleId,bodyText,callback){var msgbox=$modal.open({templateUrl:"/web/webjars/common/webcert/js/services/dialogServiceMessageTemplate.html",controller:["$scope","$modalInstance","bodyText","titleId",function($scope,$modalInstance,bodyText,titleId){$scope.bodyText=bodyText,$scope.titleId=titleId}],resolve:{bodyText:function(){return angular.copy(bodyText)},titleId:function(){return angular.copy(titleId)}}});msgbox.result["finally"](function(result){callback&&callback(result)})}function _showDialog(scope,options){if(void 0===scope.dialog&&(scope.dialog={}),scope.dialog.errormessageid=scope.dialog.errormessageid?scope.dialog.errormessageid:"common.error.cantconnect",scope.dialog.acceptprogressdone=scope.dialog.acceptprogressdone?scope.dialog.acceptprogressdone:!0,scope.dialog.focus=scope.dialog.focus?scope.dialog.focus:!1,scope.dialog.showerror=scope.dialog.showerror?scope.dialog.showerror:!1,void 0===options.dialogId)throw"dialogId must be specified";options.bodyText=void 0===options.bodyText?"":options.bodyText,options.button1text=void 0===options.button1text?"common.ok":options.button1text,options.button2text=void 0===options.button2text?"common.cancel":options.button2text,options.button3text=void 0===options.button3text?void 0:options.button3text,options.button3visible=void 0===options.button3visible?void 0!==options.button3text:options.button3visible,options.button1id=void 0===options.button1id?"button1"+options.dialogId:options.button1id,options.button2id=void 0===options.button2id?"button2"+options.dialogId:options.button2id,options.button3id=void 0===options.button3id?"button3"+options.dialogId:options.button3id,options.autoClose=void 0===options.autoClose?!0:options.autoClose,options.templateUrl=void 0===options.templateUrl?"/views/partials/common-dialog.html":options.templateUrl,options.model=void 0===options.model?void 0:options.model;var DialogInstanceCtrl=["$scope","$modalInstance","model","dialogId","titleId","bodyTextId","bodyText","button1id","button2id","button3id","button1click","button2click","button3click","button3visible","button1text","button2text","button3text","autoClose",function($scope,$modalInstance,model,dialogId,titleId,bodyTextId,bodyText,button1id,button2id,button3id,button1click,button2click,button3click,button3visible,button1text,button2text,button3text,autoClose){$scope.model=model,$scope.dialogId=dialogId,$scope.titleId=titleId,$scope.bodyTextId=bodyTextId,$scope.bodyText=bodyText,$scope.button1click=function(result){button1click(),autoClose&&$modalInstance.close(result)},$scope.button2click=function(){button2click&&button2click(),$modalInstance.dismiss("button2 dismiss")},$scope.button3visible=button3visible,void 0!==$scope.button3visible?$scope.button3click=function(){button3click&&button3click(),$modalInstance.dismiss("button3 dismiss")}:$scope.button3visible=!1,$scope.button1text=button1text,$scope.button2text=button2text,$scope.button3text=button3text,$scope.button1id=button1id,$scope.button2id=button2id,$scope.button3id=button3id}],msgbox=$modal.open({scope:scope,templateUrl:options.templateUrl,controller:DialogInstanceCtrl,resolve:{model:function(){return options.model},dialogId:function(){return angular.copy(options.dialogId)},titleId:function(){return angular.copy(options.titleId)},bodyTextId:function(){return angular.copy(options.bodyTextId)},bodyText:function(){return angular.copy(options.bodyText)},button1id:function(){return angular.copy(options.button1id)},button2id:function(){return angular.copy(options.button2id)},button3id:function(){return angular.copy(options.button3id)},button1click:function(){return options.button1click},button2click:function(){return options.button2click},button3click:function(){return options.button3click},button1text:function(){return angular.copy(options.button1text)},button2text:function(){return angular.copy(options.button2text)},button3text:function(){return angular.copy(options.button3text)},button3visible:function(){return angular.copy(options.button3visible)},autoClose:function(){return angular.copy(options.autoClose)}}});return msgbox.result.then(function(result){options.callback&&options.callback(result)},function(){}),msgbox}return{showErrorMessageDialog:_showErrorMessageDialog,showMessageDialog:_showMessageDialog,showDialog:_showDialog}}]),angular.module("common").factory("common.fragaSvarCommonService",["$http","$log","$modal","$window",function($http,$log,$modal,$window){"use strict";function _setVidareBefordradState(id,isVidareBefordrad,callback){$log.debug("_setVidareBefordradState");var restPath="/moduleapi/fragasvar/"+id+"/setDispatchState";$http.put(restPath,isVidareBefordrad.toString()).success(function(data){$log.debug("_setVidareBefordradState data:"+data),callback(data)}).error(function(data,status){$log.error("error "+status),callback(null)})}function _buildMailToLink(qa){var baseURL=$window.location.protocol+"//"+$window.location.hostname+($window.location.port?":"+$window.location.port:""),url=baseURL+"/m/fk7263/webcert/intyg/"+qa.intygsReferens.intygsId+"#/view",recipient="",subject="En fraga-svar ska besvaras i Webcert.";void 0!==qa.vardperson.enhetsnamn&&(subject+=" på enhet "+qa.vardperson.enhetsnamn,void 0!==qa.vardperson.vardgivarnamn&&(subject+=" för vårdgivare "+qa.vardperson.vardgivarnamn));var body="Klicka pa lanktexten for att besvara fraga-svar::\n"+url,link="mailto:"+recipient+"?subject="+encodeURIComponent(subject)+"&body="+encodeURIComponent(body);return $log.debug(link),link}function _setSkipVidareBefodradCookie(){var secsDays=31104e6,now=new Date,expires=new Date(now.getTime()+secsDays);document.cookie="WCDontAskForVidareBefordradToggle=1; expires="+expires.toUTCString()}function _isSkipVidareBefodradCookieSet(){return document.cookie&&-1!==document.cookie.indexOf("WCDontAskForVidareBefordradToggle=1")}function _decorateSingleItemMeasure(qa){"CLOSED"===qa.status?qa.measureResKey="handled":"ANSWERED"===qa.status||"MAKULERING"===qa.amne||"PAMINNELSE"===qa.amne?qa.measureResKey="markhandled":"KOMPLETTERING_AV_LAKARINTYG"===qa.amne?qa.measureResKey="komplettering":"PENDING_INTERNAL_ACTION"===qa.status?qa.measureResKey="svarfranvarden":"PENDING_EXTERNAL_ACTION"===qa.status?qa.measureResKey="svarfranfk":(qa.measureResKey="",$log.debug("warning: undefined status"))}function _showVidarebefordradPreferenceDialog(title,bodyText,yesCallback,noCallback,noDontAskCallback,callback){var DialogInstanceCtrl=["$scope","$modalInstance","title","bodyText","yesCallback","noCallback","noDontAskCallback",function($scope,$modalInstance,title,bodyText,yesCallback,noCallback,noDontAskCallback){$scope.title=title,$scope.bodyText=bodyText,$scope.noDontAskVisible=void 0!==noDontAskCallback,$scope.yes=function(result){yesCallback(),$modalInstance.close(result)},$scope.no=function(){noCallback(),$modalInstance.close("cancel")},$scope.noDontAsk=function(){noDontAskCallback(),$modalInstance.close("cancel_dont_ask_again")}}],msgbox=$modal.open({templateUrl:"/views/partials/preference-dialog.html",controller:DialogInstanceCtrl,resolve:{title:function(){return angular.copy(title)},bodyText:function(){return angular.copy(bodyText)},yesCallback:function(){return yesCallback},noCallback:function(){return noCallback},noDontAskCallback:function(){return noDontAskCallback}}});msgbox.result.then(function(result){callback&&callback(result)},function(){})}function _handleVidareBefodradToggle(qa,onYesCallback){qa.vidarebefordrad||_isSkipVidareBefodradCookieSet()||_showVidarebefordradPreferenceDialog("markforward","Det verkar som att du har informerat den som ska hantera ärendet. Vill du markera ärendet som vidarebefordrat?",function(){$log.debug("yes"),qa.vidarebefordrad=!0,onYesCallback&&onYesCallback(qa)},function(){$log.debug("no")},function(){$log.debug("no and dont ask"),_setSkipVidareBefodradCookie()})}return{setVidareBefordradState:_setVidareBefordradState,handleVidareBefodradToggle:_handleVidareBefodradToggle,buildMailToLink:_buildMailToLink,decorateSingleItemMeasure:_decorateSingleItemMeasure}}]),angular.module("common").provider("common.http403ResponseInterceptor",function(){"use strict";this.config={redirectUrl:"/"},this.setRedirectUrl=function(url){this.config.redirectUrl=url},this.$get=["$q","$window",function($q,$window){function interceptorImpl(promise){return promise.then(function(response){return response},function(response){return 403===response.status&&($window.location.href=config.redirectUrl),$q.reject(response)})}var config=this.config;return interceptorImpl}]}),angular.module("common").factory("common.httpRequestInterceptorCacheBuster",["$q",function($q){"use strict";return{request:function(config){if(-1===config.url.indexOf(".html")){var sep=-1===config.url.indexOf("?")?"?":"&";config.url=config.url+sep+"cacheSlayer="+(new Date).getTime()}return config||$q.when(config)}}}]),angular.module("common").factory("common.ManageCertView",["$document","$log","$location","$route","$routeParams","$timeout","$window","common.CertificateService","common.dialogService","common.messageService","common.statService","common.User",function($document,$log,$location,$route,$routeParams,$timeout,$window,CertificateService,dialogService,messageService,statService,User){"use strict";function _load($scope,onSuccess){$scope.widgetState.doneLoading=!1,CertificateService.getDraft($routeParams.certificateId,function(data){$scope.widgetState.doneLoading=!0,$scope.widgetState.activeErrorMessageKey=null,$scope.cert=data.content,$scope.isSigned="SIGNED"===data.status,$scope.isComplete=$scope.isSigned||"DRAFT_COMPLETE"===data.status,void 0!==onSuccess&&onSuccess(data.content)},function(error){$scope.widgetState.doneLoading=!0,$scope.widgetState.activeErrorMessageKey=checkSetError(error.errorCode)})}function _save($scope){CertificateService.saveDraft($routeParams.certificateId,$scope.cert,function(data){$scope.certForm.$setPristine(),$scope.validationMessagesGrouped={},$scope.validationMessages=[],"COMPLETE"===data.status?$scope.isComplete=!0:($scope.isComplete=!1,$scope.validationMessages=data.messages,angular.forEach(data.messages,function(message){var section,field=message.field,parts=field.split(".");parts.length>0&&(section=parts[0].toLowerCase(),$scope.validationMessagesGrouped[section]?$scope.validationMessagesGrouped[section].push(message):$scope.validationMessagesGrouped[section]=[message])}))},function(error){$scope.widgetState.activeErrorMessageKey=checkSetError(error.errorCode)})}function _discard($scope){var bodyText="När du raderar utkastet tas det bort från Webcert.";$scope.dialog={acceptprogressdone:!1,errormessageid:"Error",showerror:!1};var draftDeleteDialog={};draftDeleteDialog=dialogService.showDialog($scope,{dialogId:"confirm-draft-delete",titleId:"common.modal.label.discard_draft",bodyText:bodyText,button1id:"confirm-draft-delete-button",button1click:function(){$log.debug("delete draft "),$scope.dialog.acceptprogressdone=!1,CertificateService.discardDraft($routeParams.certificateId,function(){$scope.dialog.acceptprogressdone=!0,statService.refreshStat(),$location.path("/unsigned"),draftDeleteDialog.close()},function(error){$scope.dialog.acceptprogressdone=!0,"DATA_NOT_FOUND"===error.errorCode?(statService.refreshStat(),draftDeleteDialog.close(),$location.path("/unsigned")):($scope.dialog.showerror=!0,$scope.dialog.errormessageid=""===error?"common.error.cantconnect":("error.message."+error.errorCode).toLowerCase())})},button1text:"common.delete",button2text:"common.cancel",autoClose:!1})}function checkSetError(errorCode){var model="common.error.unknown";return void 0!==errorCode&&null!==errorCode&&(model=("common.error."+errorCode).toLowerCase()),model}function signera($scope,intygsTyp){return"urn:inera:webcert:fake"===User.userContext.authenticationScheme?_signeraServer($scope,intygsTyp,$routeParams.certificateId):_signeraKlient($scope,intygsTyp,$routeParams.certificateId)}function _signeraServer($scope,intygsTyp,intygId){var bodyText="Är du säker på att du vill signera intyget?",confirmDialog=dialogService.showDialog($scope,{dialogId:"confirm-sign",titleId:"common.modal.label.confirm_sign",bodyText:bodyText,autoClose:!1,button1id:"confirm-signera-utkast-button",button1click:function(){_confirmSignera($scope,intygsTyp,intygId,confirmDialog)},button1text:"common.sign",button2click:function(){$scope._timer&&$timeout.cancel($scope._timer),$scope.dialog.acceptprogressdone=!0},button2text:"common.cancel"})}function _signeraKlient($scope,intygsTyp,intygId){CertificateService.getSigneringshash(intygId,function(ticket){_openNetIdPlugin(ticket.hash,function(signatur){CertificateService.signeraUtkastWithSignatur(ticket.id,signatur,function(ticket){"SIGNERAD"===ticket.status?_showIntygAfterSignering(intygsTyp,intygId):_waitForSigneringsstatusSigneradAndClose($scope,intygsTyp,intygId,ticket)
},function(error){_showSigneringsError($scope,error)})},function(error){_showSigneringsError($scope,error)})},function(error){_showSigneringsError($scope,error)})}function _confirmSignera($scope,intygsTyp,intygId,confirmDialog){$scope.dialog.acceptprogressdone=!1,$scope.dialog.showerror=!1,CertificateService.signeraUtkast(intygId,function(ticket){_waitForSigneringsstatusSigneradAndClose($scope,intygsTyp,intygId,ticket,confirmDialog)},function(error){_showSigneringsError($scope,error)})}function _openNetIdPlugin(hash,onSuccess){iid_SetProperty("Base64","true"),iid_SetProperty("DataToBeSigned",hash),iid_SetProperty("URLEncode","false");var resultCode=iid_Invoke("Sign");0===resultCode?onSuccess(iid_GetProperty("Signature")):$log.info("Signeringen avbröts med kod: "+resultCode)}function _waitForSigneringsstatusSigneradAndClose($scope,intygsTyp,intygId,ticket,dialog){function getSigneringsstatus(){CertificateService.getSigneringsstatus(ticket.id,function(ticket){"BEARBETAR"===ticket.status?$scope._timer=$timeout(getSigneringsstatus,1e3):"SIGNERAD"===ticket.status?_showIntygAfterSignering(intygsTyp,intygId,dialog):_showSigneringsError($scope,{errorCode:"SIGN_ERROR"})})}getSigneringsstatus()}function _showIntygAfterSignering(intygsTyp,intygId,dialog){dialog&&dialog.close(),$location.path("/intyg/"+intygsTyp+"/"+intygId),statService.refreshStat()}function _showSigneringsError($scope,error){if($scope.dialog)$scope.dialog.acceptprogressdone=!0,$scope.dialog.showerror=!0,$scope.dialog.errormessageid="DATA_NOT_FOUND"===error.errorCode?"common.error.certificatenotfound":"INVALID_STATE"===error.errorCode?"common.error.certificateinvalid":""===error?"common.error.cantconnect":"common.error.signerror";else{var errorMessage=messageService.getProperty(error,null,error);dialogService.showErrorMessageDialog(errorMessage)}}function _isSentToTarget(statusArr,target){if(statusArr)for(var i=0;i<statusArr.length;i++)if(statusArr[i].target===target&&"SENT"===statusArr[i].type)return!0;return!1}function _isRevoked(statusArr){if(statusArr)for(var i=0;i<statusArr.length;i++)if("CANCELLED"===statusArr[i].type)return!0;return!1}function _printDraft(intygId){$window.print(),CertificateService.logPrint(intygId,function(data){$log.debug("_logPrint, success: "+data)})}return{load:_load,save:_save,discard:_discard,signera:signera,isRevoked:_isRevoked,isSentToTarget:_isSentToTarget,printDraft:_printDraft,__test__:{confirmSignera:_confirmSignera}}}]),angular.module("common").factory("common.messageService",["$rootScope",function($rootScope){"use strict";function _getProperty(key,variables,defaultValue,language,fallbackToDefaultLanguage){var value;return language||(language=$rootScope.lang,!language&&fallbackToDefaultLanguage&&(language=$rootScope.DEFAULT_LANG)),language?(value=_getPropertyInLanguage(language,key,variables),(null===value||void 0===value)&&(value=null===defaultValue||void 0===defaultValue?'[Missing "'+key+'"]':defaultValue)):value="[Missing language]",value}function _getPropertyInLanguage(lang,key,variables){_checkResources();var message=_messageResources[lang][key];return angular.forEach(variables,function(value,key){var regexp=new RegExp("\\$\\{"+key+"\\}","g");message=message.replace(regexp,value)}),message}function _addResources(resources){_checkResources(),angular.extend(_messageResources.sv,resources.sv),angular.extend(_messageResources.en,resources.en)}function _checkResources(){null===_messageResources&&(_messageResources={sv:{"initial.key":"Initial nyckel"},en:{"initial.key":"Initial key"}})}var _messageResources=null;return{getProperty:_getProperty,addResources:_addResources}}]),angular.module("common").factory("common.statService",["$http","$log","$rootScope","$timeout",function($http,$log,$rootScope,$timeout){"use strict";function _stopPolling(){timeOutPromise&&($timeout.cancel(timeOutPromise),$log.debug("statService -> Stop polling"))}function _refreshStat(){$log.debug("_getStat"),$http.get("/moduleapi/stat/").success(function(data){$log.debug("_getStat success - data:"+data),$rootScope.$broadcast("wc-stat-update",data),_stopPolling(),timeOutPromise=$timeout(_refreshStat,msPollingInterval)}).error(function(data,status){$log.error("_getStat error "+status),_stopPolling(),timeOutPromise=$timeout(_refreshStat,msPollingInterval)})}function _startPolling(){_refreshStat(),$log.debug("statService -> Start polling")}var timeOutPromise,msPollingInterval=6e4;return{startPolling:_startPolling,stopPolling:_stopPolling,refreshStat:_refreshStat}}]),angular.module("common").factory("common.User",["$http","$log",function($http,$log){"use strict";return{reset:function(){this.userContext=null},setUserContext:function(userContext){this.userContext=userContext},getVardenhetSelectionList:function(){var ucVardgivare=angular.copy(this.userContext.vardgivare),vardgivareList=[];return angular.forEach(ucVardgivare,function(vardgivare,key1){this.push({id:vardgivare.id,namn:vardgivare.namn,vardenheter:[]}),angular.forEach(vardgivare.vardenheter,function(vardenhet){this.push({id:vardenhet.id,namn:vardenhet.namn}),angular.forEach(vardenhet.mottagningar,function(mottagning){mottagning.namn=vardenhet.namn+" - "+mottagning.namn,this.push(mottagning)},vardgivareList[key1].vardenheter)},vardgivareList[key1].vardenheter)},vardgivareList),vardgivareList},getVardenhetFilterList:function(vardenhet){if(!vardenhet){if(!this.userContext.valdVardenhet)return $log.debug("getVardenhetFilterList: parameter vardenhet was omitted"),[];$log.debug("getVardenhetFilterList: using valdVardenhet"),vardenhet=this.userContext.valdVardenhet}var vardenhetCopy=angular.copy(vardenhet),units=[];return units.push(vardenhetCopy),angular.forEach(vardenhetCopy.mottagningar,function(mottagning){mottagning.namn=vardenhet.namn+" - "+mottagning.namn,this.push(mottagning)},units),units},getValdVardgivare:function(){return this.userContext.valdVardgivare},getValdVardenhet:function(){return this.userContext.valdVardenhet},setValdVardenhet:function(vardenhet,onSuccess,onError){$log.debug("setValdVardenhet"+vardenhet.namn);var payload=vardenhet,self=this,restPath="/api/user/changeunit";$http.post(restPath,payload).success(function(data){$log.debug("got callback data: "+data),self.setUserContext(data),onSuccess(data)}).error(function(data,status){$log.error("error "+status),onError(data)})}}}]);